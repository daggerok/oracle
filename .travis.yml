services:
- docker

env:
  global:
  - TERM=dumb
  - DOCKER_USERNAME=daggerok
  - DOCKER_IMAGE_NAME=oracle
  - secure: bL9hUeeCwKIRhq5FEt6INEzbPDSqOtP0J+owkPDQUUvux8FmvBBlPTWyobLjzKA+3hy4Om3ABdpoiKevatyOJJ+yx2FZuLU4pko/Tk58G4bTBJLIE9W2JhV2yJcvg1d/Mrzwgq6EYcPrUIXVqE9+lB9Hrduu4P4LemGrY0UDnzsumFcoIaVtQt7kEMLlEq4amNrnnmoZLYGGie3PcUhq26HFYKlWQ6rJihN2Nt2WJX9s7IqkMlCzikYZ4+uYEk6i9uwijF1+tkjWSxkuU1KRd51aQ/rF0xJdyP5eeWl049DPyJT4FI8E+F8r+qjHya7BUpxlouRWTRMyT3e0k3zDQ7htcu4AD3D/kipvZInpOqtTRzBdlCAAYRurqEwbAOA8fPb+eXikdILaf05jGnxTMMp6QPoi7dKjJQKSBWwF3EZDIfWDDYD6g2fEkgfJPB7OW3fd1+F/fms4Kj49XE+qER2OGBAr+HiHQ5QYMTdyzQYTy7r99EcilO3Dk39XT78pvfD3VqLC57qhM944EWEYIvWNi3z3P53tu2YateRzXBPZJAm3hn89SNnjOys3WZy+50BUmvfiayDhboc4t5qA5c4LXiC+NAlM2XN/Ne2rVCRiz+sIfksaxy1FKV5NLXLTI0iV7hEL48rBGiobW95yteQ8sjqFI8bANFowSF9U7h4=

install: true
before_install:
- sudo apt update -y >/dev/null 2>&1 || true
- sudo apt install -y --no-install-recommends curl wget unzip bash >/dev/null 2>&1 || true
- source <(curl -s https://raw.githubusercontent.com/daggerok/bash-functions/master/main.bash)
- stop_any 1521 8080 80

script:

# build
- export root=$(pwd)
- wget -q -O docker-images-master.zip https://codeload.github.com/oracle/docker-images/zip/master
- unzip docker-images-master.zip
- wget -q -O ${root}/docker-images-master/OracleDatabase/SingleInstance/dockerfiles/11.2.0.2/oracle-xe-11.2.0-1.0.x86_64.rpm.zip https://github.com/daggerok/oracle/releases/download/oracle/oracle-xe-11.2.0-1.0.x86_64.rpm.zip
- cd ${root}/docker-images-master/OracleDatabase/SingleInstance/dockerfiles/
- bash ./buildDockerImage.sh -v 11.2.0.2 -x

# tag
- export CURRENT_DATE=$(date +%Y-%m-%d)
- |
  if [ "master" == "${TRAVIS_BRANCH}" ]; then
    docker tag oracle/database:11.2.0.2-xe ${CURRENT_DATE}:for-test
    docker tag oracle/database:11.2.0.2-xe ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}
    docker tag oracle/database:11.2.0.2-xe ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:latest
  else
    docker tag oracle/database:${TRAVIS_BRANCH} ${CURRENT_DATE}:for-test
    docker tag oracle/database:${TRAVIS_BRANCH} ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${TRAVIS_BRANCH}
  fi

# test image
- export SPRING_DATASOURCE_PASSWORD=${CURRENT_DATE}
- docker images
- >
  docker run -d --rm --name oracle-xe \
    --shm-size=1g \
    -p 1521:1521 \
    -e ORACLE_PWD=$SPRING_DATASOURCE_PASSWORD \
    ${CURRENT_DATE}:for-test
- wait_for 1521
- docker logs -f oracle-xe &
- sleep 150
- bash ${root}/app/gradlew -b ${root}/app/build.gradle >/dev/null 2>&1
- bash ${root}/app/build/libs/*.jar
- docker rm -f -v oracle-xe

after_success:

# push OK image
- echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin
- docker push ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}

# finally test pushed image
- docker pull ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}
- >
  docker run -d --rm --name oracle-xe \
    --shm-size=1g \
    -p 1521:1521 \
    -e ORACLE_PWD=$SPRING_DATASOURCE_PASSWORD \
    ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}
- wait_for 1521
- docker logs -f oracle-xe &
- sleep 150
- cd ${root}/app
- bash ./mvnw >/dev/null 2>&1
- bash ./target/*.jar
- docker rm -f -v oracle-xe
